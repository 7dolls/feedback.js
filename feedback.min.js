/*
 feedback.js <http://experiments.hertzen.com/jsfeedback/>
 Copyright (c) 2012 Niklas von Hertzen. All rights reserved.
 http://www.twitter.com/niklasvh

 Released under MIT License
*/
(function(e,t,n){function r(e){return o[e]}var i={label:"Send Feedback",header:"Send Feedback",nextLabel:"Continue",reviewLabel:"Review",sendLabel:"Send",closeLabel:"Close",messageSuccess:"Your feedback was sent succesfully.",messageError:"There was an error sending your feedback to the server."},s=Object.create(i),o=Object.create(s);if(e.Feedback!==n)return;var u=function(t){e.console.log(t)},a=function(e){for(var t=0,r=e.length;t<r;t++){var i=Array.prototype.pop.call(e);i!==n&&i.parentNode!==null&&i.parentNode.removeChild(i)}},f=function(){var e=t.createElement("div"),n=3;e.className="feedback-loader";while(n--)e.appendChild(t.createElement("span"));return e},l=function(e){return e.getBoundingClientRect()},c=function(e){var t;while((t=e.firstChild)!==null?e.removeChild(t):!1);},h=function(e,n){var r=t.createElement(e);return r.appendChild(t.createTextNode(n)),r},p=function(t,r){if(t.onload!==n)return r;if(t.onreadystatechange!==n){var i=function(){t.readyState!=="loaded"&&t.readyState!=="complete"?e.setTimeout(i,250):r()};e.setTimeout(i,250)}else u("ERROR: We can't track when script is loaded")},d,v="data-html2canvas-ignore",m,g=t.createElement("div");e.Feedback=function(i){i=i||{},i.header=i.header||"Send Feedback",i.url=i.url||"/",i.adapter=i.adapter||new e.Feedback.XHR(i.url),i.nextLabel=i.nextLabel||"Continue",i.reviewLabel=i.reviewLabel||"Review",i.sendLabel=i.sendLabel||"Send",i.closeLabel=i.closeLabel||"Close",i.messageSuccess=i.messageSuccess||"Your feedback was sent succesfully.",i.messageError=i.messageError||"There was an error sending your feedback to the server.",i.pages===n&&(i.pages=[new e.Feedback.Form,new e.Feedback.Screenshot(i),new e.Feedback.Review]);var s,o,u,l=t.createElement("div"),p={open:function(){var n=i.pages.length;u=0;for(;u<n;u++)i.pages[u]instanceof e.Feedback.Review||i.pages[u].render();var r=h("a","×"),a=t.createElement("div"),f=t.createElement("div");o=t.createElement("div"),t.body.appendChild(l),r.className="feedback-close",r.onclick=p.close,r.href="#",s.disabled=!0,a.appendChild(r),a.appendChild(h("h3",i.header)),a.className="feedback-header",g.className="feedback-body",c(g),u=0,g.appendChild(i.pages[u++].dom),d=h("button",i.nextLabel),d.className="feedback-btn",d.onclick=function(){if(u>0&&i.pages[u-1].end(o)===!1)return;c(g),u===n?p.send(i.adapter):(i.pages[u].start(o,a,f,d),i.pages[u]instanceof e.Feedback.Review&&i.pages[u].render(i.pages),g.appendChild(i.pages[u++].dom),u===n&&(d.firstChild.nodeValue=i.sendLabel),i.pages[u]instanceof e.Feedback.Review&&(d.firstChild.nodeValue=i.reviewLabel))},f.className="feedback-footer",f.appendChild(d),o.className="feedback-modal",o.setAttribute(v,!0),o.appendChild(a),o.appendChild(g),o.appendChild(f),t.body.appendChild(o)},close:function(){s.disabled=!1,a([o,l]),u>0&&i.pages[u-1].end(o);for(var e=0,t=i.pages.length;e<t;e++)i.pages[e].close();return!1},send:function(n){if(!(n instanceof e.Feedback.Send))throw new Error("Adapter is not an instance of Feedback.Send");for(var r=0,s=i.pages.length,o=[],u=0,a;r<s;r++)(a=i.pages[r].data())!==!1&&(o[u++]=a);d.disabled=!0,c(g),g.appendChild(f()),n.send(o,function(e){c(g),d.disabled=!1,d.firstChild.nodeValue=i.closeLabel,d.onclick=function(){return p.close(),!1},e===!0?g.appendChild(t.createTextNode(i.messageSuccess)):g.appendChild(t.createTextNode(i.messageError))})}};return l.className="feedback-glass",l.style.pointerEvents="none",l.setAttribute(v,!0),i=i||{},s=h("button",r("label")),s.className="feedback-btn feedback-bottom-right",s.setAttribute(v,!0),s.onclick=p.open,i.appendTo!==null&&(i.appendTo!==n?i.appendTo:t.body).appendChild(s),p},e.Feedback.Page=function(){},e.Feedback.Page.prototype={render:function(e){this.dom=e},start:function(){},close:function(){},data:function(){return!1},review:function(){return null},end:function(){return!0}},e.Feedback.Send=function(){},e.Feedback.Send.prototype={send:function(){}},e.Feedback.Form=function(e){this.elements=e||[{type:"textarea",name:"Issue",label:"Please describe the issue you are experiencing",required:!1}],this.dom=t.createElement("div")},e.Feedback.Form.prototype=new e.Feedback.Page,e.Feedback.Form.prototype.render=function(){var e=0,n=this.elements.length,r;c(this.dom);for(;e<n;e++){r=this.elements[e];switch(r.type){case"textarea":this.dom.appendChild(h("label",r.label+":"+(r.required===!0?" *":""))),this.dom.appendChild(r.element=t.createElement("textarea"))}}return this},e.Feedback.Form.prototype.end=function(){var e=0,t=this.elements.length,n;for(;e<t;e++){n=this.elements[e];if(n.required===!0&&n.element.value.length===0)return n.element.className="feedback-error",!1;n.element.className=""}return!0},e.Feedback.Form.prototype.data=function(){if(this._data!==n)return this._data;var e=0,t=this.elements.length,r,i={};for(;e<t;e++)r=this.elements[e],i[r.name]=r.element.value;return this._data=i},e.Feedback.Form.prototype.review=function(e){var n=0,r,i=this.elements.length;for(;n<i;n++)r=this.elements[n],r.element.value.length>0&&(e.appendChild(h("label",r.name+":")),e.appendChild(t.createTextNode(r.element.value.length)),e.appendChild(t.createElement("hr")));return e},e.Feedback.Review=function(){this.dom=t.createElement("div"),this.dom.className="feedback-review"},e.Feedback.Review.prototype=new e.Feedback.Page,e.Feedback.Review.prototype.render=function(e){var t=0,n=e.length,r;c(this.dom);for(;t<n;t++)e[t].review(this.dom);return this},e.Feedback.Screenshot=function(e){this.options=e||{},this.options.blackoutClass=this.options.blackoutClass||"feedback-blackedout",this.options.highlightClass=this.options.highlightClass||"feedback-highlighted",this.h2cDone=!1},e.Feedback.Screenshot.prototype=new e.Feedback.Page,e.Feedback.Screenshot.prototype.end=function(e){e.className=e.className.replace(/feedback\-animate\-toside/,""),t.body.removeEventListener("mousemove",this.mouseMoveEvent,!1),t.body.removeEventListener("click",this.mouseClickEvent,!1),a([this.h2cCanvas]),this.h2cDone=!1},e.Feedback.Screenshot.prototype.close=function(){a([this.blackoutBox,this.highlightContainer,this.highlightBox,this.highlightClose]),a(t.getElementsByClassName(this.options.blackoutClass)),a(t.getElementsByClassName(this.options.highlightClass))},e.Feedback.Screenshot.prototype.start=function(r,i,s,o){if(this.h2cDone){c(this.dom),o.disabled=!1;var u=this,a="feedback-highlight-element",p="data-exclude",d=!0;this.mouseMoveEvent=function(t){if(t.target!==L&&(t.target.className.indexOf(u.options.blackoutClass)!==-1||t.target.className.indexOf(u.options.highlightClass)!==-1)){var s=parseInt(t.target.style.left,10)+parseInt(t.target.style.width,10);s=Math.max(s,10),s=Math.min(s,e.innerWidth-15);var a=parseInt(t.target.style.top,10);a=Math.max(a,10),m.style.left=s+"px",m.style.top=a+"px",w=t.target,x(),L=n;return}if(t.target.nodeName==="BODY"||t.target===m||t.target===r||t.target===o||t.target.parentNode===r||t.target.parentNode===i){x(),L=t.target;return}N(),t.target!==L&&(L=t.target,e.clearTimeout(v),v=e.setTimeout(function(){var t=l(L),n;d===!1?n=y:(n=g,n.width=t.width,n.height=t.height,E.drawImage(u.h2cCanvas,e.pageXOffset+t.left,e.pageYOffset+t.top,t.width,t.height,0,0,t.width,t.height)),n.setAttribute(p,!1),n.style.left=e.pageXOffset+t.left+"px",n.style.top=e.pageYOffset+t.top+"px",n.style.width=t.width+"px",n.style.height=t.height+"px"},100))},this.mouseClickEvent=function(e){e.preventDefault();if(d===!1){if(y.getAttribute(p)==="false"){var r=t.createElement("div");r.className=u.options.blackoutClass,r.style.left=y.style.left,r.style.top=y.style.top,r.style.width=y.style.width,r.style.height=y.style.height,t.body.appendChild(r),L=n}}else g.getAttribute(p)==="false"&&(g.className+=" "+u.options.highlightClass,g.className=g.className.replace(/feedback\-highlight\-element/g,""),u.highlightBox=g=t.createElement("canvas"),E=g.getContext("2d"),g.className+=" "+a,t.body.appendChild(g),x(),L=n)},this.highlightClose=h("div","×"),this.blackoutBox=t.createElement("div"),this.highlightBox=t.createElement("canvas"),this.highlightContainer=t.createElement("div");var v,m=this.highlightClose,g=this.highlightBox,y=this.blackoutBox,b=this.highlightContainer,w,E=g.getContext("2d"),S=function(e){e.preventDefault(),C.className.indexOf("active")===-1?(C.className+=" active",k.className=k.className.replace(/active/g,"")):(k.className+=" active",C.className=C.className.replace(/active/g,"")),d=!d},x=function(){T(y),T(g),e.clearTimeout(v)},T=function(e){e.style.left="-5px",e.style.top="-5px",e.style.width="0px",e.style.height="0px",e.setAttribute(p,!0)},N=function(){m.style.left="-50px",m.style.top="-50px"},C=h("a","Blackout"),k=h("a","Highlight"),L;r.className+=" feedback-animate-toside",m.id="feedback-highlight-close",m.addEventListener("click",function(){w.parentNode.removeChild(w),N()},!1),t.body.appendChild(m),this.h2cCanvas.className="feedback-canvas",t.body.appendChild(this.h2cCanvas);var A=[k,C];this.dom.appendChild(h("p","Highlight or blackout important information"));for(var O=0;O<2;O++)A[O].className="feedback-btn feedback-btn-small "+(O===0?"active":"feedback-btn-inverse"),A[O].href="#",A[O].onclick=S,this.dom.appendChild(A[O]),this.dom.appendChild(t.createTextNode(" "));b.id="feedback-highlight-container",b.style.width=this.h2cCanvas.width+"px",b.style.height=this.h2cCanvas.height+"px",this.highlightBox.className+=" "+a,this.blackoutBox.id="feedback-blackout-element",t.body.appendChild(this.highlightBox),b.appendChild(this.blackoutBox),t.body.appendChild(b),t.body.addEventListener("mousemove",this.mouseMoveEvent,!1),t.body.addEventListener("click",this.mouseClickEvent,!1)}else{var M=arguments,u=this;o.disabled!==!0&&this.dom.appendChild(f()),o.disabled=!0,e.setTimeout(function(){u.start.apply(u,M)},500)}},e.Feedback.Screenshot.prototype.render=function(){this.dom=t.createElement("div");var r,i=this,s=this.options,o=function(){try{s.onrendered=s.onrendered||function(e){i.h2cCanvas=e,i.h2cDone=!0},e.html2canvas([t.body],s)}catch(n){i.h2cDone=!0,u("Error in html2canvas: "+n.message)}};if(e.html2canvas===n&&r===n){r=t.createElement("script"),r.src=s.h2cPath||"libs/html2canvas.js",r.onerror=function(){u("Failed to load html2canvas library, check that the path is correctly defined")},r.onload=p(r,function(){if(e.html2canvas===n){u("Loaded html2canvas, but library not found");return}e.html2canvas.logging=e.Feedback.debug,o()});var a=t.getElementsByTagName("script")[0];a.parentNode.insertBefore(r,a)}else o();return this},e.Feedback.Screenshot.prototype.data=function(){if(this._data!==n)return this._data;if(this.h2cCanvas!==n){var e=this.h2cCanvas.getContext("2d"),r,i,s=5;e.fillStyle="#000",Array.prototype.slice.call(t.getElementsByClassName("feedback-blackedout"),0).forEach(function(t){var n=l(t);e.fillRect(n.left,n.top,n.width,n.height)});var o=Array.prototype.slice.call(t.getElementsByClassName("feedback-highlighted"),0);o.length>0&&(r=t.createElement("canvas"),i=r.getContext("2d"),r.width=this.h2cCanvas.width,r.height=this.h2cCanvas.height,i.drawImage(this.h2cCanvas,0,0),e.fillStyle="#777",e.globalAlpha=.5,e.fillRect(0,0,this.h2cCanvas.width,this.h2cCanvas.height),e.beginPath(),o.forEach(function(t){var n=parseInt(t.style.left,10),r=parseInt(t.style.top,10),i=parseInt(t.style.width,10),o=parseInt(t.style.height,10);e.moveTo(n+s,r),e.lineTo(n+i-s,r),e.quadraticCurveTo(n+i,r,n+i,r+s),e.lineTo(n+i,r+o-s),e.quadraticCurveTo(n+i,r+o,n+i-s,r+o),e.lineTo(n+s,r+o),e.quadraticCurveTo(n,r+o,n,r+o-s),e.lineTo(n,r+s),e.quadraticCurveTo(n,r,n+s,r)}),e.closePath(),e.clip(),e.globalAlpha=1,e.drawImage(r,0,0));try{return this._data=this.h2cCanvas.toDataURL()}catch(u){}}},e.Feedback.Screenshot.prototype.review=function(e){var t=this.data();if(t!==n){var r=new Image;r.src=t,r.style.width="300px",e.appendChild(r)}},e.Feedback.XHR=function(e){this.xhr=new XMLHttpRequest,this.url=e},e.Feedback.XHR.prototype=new e.Feedback.Send,e.Feedback.XHR.prototype.send=function(t,n){var r=this.xhr;r.onreadystatechange=function(){r.readyState==4&&n(r.status===200)},r.open("POST",this.url,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.send("data="+encodeURIComponent(e.JSON.stringify(t)))}})(window,document);
